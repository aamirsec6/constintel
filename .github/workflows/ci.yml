# GENERATOR: CI
# GitHub Actions CI/CD Pipeline
# ASSUMPTIONS: GitHub repository, secrets configured
# HOW TO RUN: Automatically runs on push/PR, or manually via GitHub Actions UI

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch: # Allow manual trigger

env:
  NODE_VERSION: '20.x'
  PYTHON_VERSION: '3.11'

jobs:
  # Backend Tests
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: constintel
          POSTGRES_PASSWORD: constintel
          POSTGRES_DB: constintel_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Generate Prisma Client
        working-directory: ./backend
        run: npx prisma generate
        env:
          DATABASE_URL: postgresql://constintel:constintel@localhost:5432/constintel_test
      
      - name: Run database migrations
        working-directory: ./backend
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://constintel:constintel@localhost:5432/constintel_test
      
      - name: Run linter
        working-directory: ./backend
        run: npm run lint || true
      
      - name: Run tests
        working-directory: ./backend
        run: npm test
        env:
          DATABASE_URL: postgresql://constintel:constintel@localhost:5432/constintel_test
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test

  # Frontend Tests
  frontend-test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Run linter
        working-directory: ./frontend
        run: npm run lint || true
      
      - name: Build
        working-directory: ./frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3000
          NEXT_PUBLIC_ML_API_URL: http://localhost:8000

  # ML Service Tests
  ml-service-test:
    name: ML Service Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: constintel
          POSTGRES_PASSWORD: constintel
          POSTGRES_DB: constintel_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: services/ml_service/requirements.txt
      
      - name: Install dependencies
        working-directory: ./services/ml_service
        run: |
          pip install -r requirements.txt
      
      - name: Run feature builder tests
        working-directory: ./services/ml_service
        run: |
          python3 -c "from train.feature_builder import build_features_for_profile; print('✅ Feature builder imports OK')"
        env:
          DATABASE_URL: postgresql://constintel:constintel@localhost:5432/constintel_test
      
      - name: Test model training (dry run)
        working-directory: ./services/ml_service
        run: |
          python3 -c "from train.train_models import load_training_data; print('✅ Training script imports OK')"
        env:
          DATABASE_URL: postgresql://constintel:constintel@localhost:5432/constintel_test

  # Integration Tests
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend-test, ml-service-test]
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: constintel
          POSTGRES_PASSWORD: constintel
          POSTGRES_DB: constintel_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: services/ml_service/requirements.txt
      
      - name: Install ML dependencies
        working-directory: ./services/ml_service
        run: pip install -r requirements.txt
      
      - name: Run database migrations
        working-directory: ./backend
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://constintel:constintel@localhost:5432/constintel_test
      
      - name: Start backend
        working-directory: ./backend
        run: |
          npm run build
          npm start &
          sleep 5
        env:
          DATABASE_URL: postgresql://constintel:constintel@localhost:5432/constintel_test
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test
          PORT: 3000
      
      - name: Start ML service
        working-directory: ./services/ml_service
        run: |
          python3 -m uvicorn api.main:app --host 0.0.0.0 --port 8000 &
          sleep 5
        env:
          DATABASE_URL: postgresql://constintel:constintel@localhost:5432/constintel_test
          REDIS_URL: redis://localhost:6379
      
      - name: Test API endpoints
        run: |
          # Test backend health
          curl -f http://localhost:3000/health || exit 1
          
          # Test ML service health
          curl -f http://localhost:8000/health || exit 1
          
          # Test event ingestion
          curl -f -X POST http://localhost:3000/api/events \
            -H "Content-Type: application/json" \
            -H "x-brand-id: test-brand" \
            -d '{"event_type": "purchase", "payload": {"phone": "+1234567890", "total": 99.99}}' || exit 1
          
          echo "✅ Integration tests passed"
      
      - name: Cleanup
        if: always
        run: |
          pkill -f "node.*server" || true
          pkill -f "uvicorn" || true

  # Build Docker Images (on main branch)
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test, ml-service-test]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          tags: constintel-backend:latest
          cache-from: type=registry,ref=constintel-backend:latest
          cache-to: type=inline
      
      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          tags: constintel-frontend:latest
          cache-from: type=registry,ref=constintel-frontend:latest
          cache-to: type=inline
      
      - name: Build ML service image
        uses: docker/build-push-action@v5
        with:
          context: ./services/ml_service
          file: ./services/ml_service/Dockerfile
          push: false
          tags: constintel-ml-service:latest
          cache-from: type=registry,ref=constintel-ml-service:latest
          cache-to: type=inline

