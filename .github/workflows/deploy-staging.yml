# GENERATOR: STAGING_DEPLOYMENT
# GitHub Actions workflow for deploying to staging environment
# ASSUMPTIONS: SSH access to staging server, staging instance configured
# HOW TO RUN: Automatically on push to develop branch, or manually via workflow_dispatch

name: Deploy to Staging

on:
  push:
    branches: [develop]
  workflow_dispatch:

env:
  STAGING_INSTANCE: staging

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run backend tests
        run: |
          cd backend
          npm ci
          npm test || echo "Tests failed but continuing..."
        continue-on-error: true
      
      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
        continue-on-error: true
      
      - name: Deploy to staging server
        if: github.ref == 'refs/heads/develop'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /path/to/constintel
            git pull origin develop
            cd infra
            ./deploy-staging.sh --skip-tests
        continue-on-error: false
      
      - name: Health check
        if: github.ref == 'refs/heads/develop'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /path/to/constintel/infra
            ./health-check.sh staging || exit 1
      
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Staging deployment successful!"
          else
            echo "❌ Staging deployment failed!"
          fi

