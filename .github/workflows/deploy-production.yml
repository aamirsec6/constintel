# GENERATOR: PRODUCTION_DEPLOYMENT
# GitHub Actions workflow for deploying to production environment
# ASSUMPTIONS: SSH access to production server, production instance configured
# HOW TO RUN: Manually via workflow_dispatch or on push to main (with approval)

name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        default: 'false'
        type: boolean

env:
  PRODUCTION_INSTANCE: production

jobs:
  pre-deployment-check:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify staging is stable
        run: |
          echo "⚠️  Verify staging environment is stable before proceeding"
          echo "Check staging health and test results before production deployment"
      
      - name: Run comprehensive tests
        if: ${{ !inputs.skip_tests }}
        run: |
          cd backend
          npm ci
          npm test || exit 1
          
          cd ../frontend
          npm ci
          npm run build || exit 1
      
      - name: Check for migration files
        run: |
          if [ -n "$(find backend/prisma/migrations -name '*.sql' -newer backend/prisma/migrations/migration_lock.toml 2>/dev/null)" ]; then
            echo "⚠️  New migrations detected - ensure they've been tested in staging!"
          fi

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: pre-deployment-check
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment:
      name: production
      url: http://your-production-domain.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to production server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            set -e
            cd /path/to/constintel
            git pull origin main
            cd infra
            
            # Create backup before deployment
            ./backup-database.sh production "pre-deployment-$(date +%Y%m%d-%H%M%S)"
            
            # Deploy
            if [ "${{ inputs.skip_tests }}" == "true" ]; then
              ./deploy-production.sh --skip-tests
            else
              ./deploy-production.sh
            fi
      
      - name: Production health check
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /path/to/constintel/infra
            ./health-check.sh production || exit 1
      
      - name: Monitor deployment
        run: |
          echo "⚠️  Monitor production closely for the next 10 minutes"
          echo "Check logs and metrics for any issues"
      
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Production deployment successful!"
            echo "Monitor application for the next few minutes"
          else
            echo "❌ Production deployment failed!"
            echo "Consider rolling back: ./rollback.sh production"
          fi

